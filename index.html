<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nearby Helper + Live Chat</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Poppins;}
body{background:#0f172a;color:white;min-height:100vh;display:flex;flex-direction:column;}
.header{padding:16px;background:#020617;text-align:center;color:#22c55e;font-weight:bold;}
.section{display:none;flex:1;overflow:auto;}
.show{display:flex;}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;padding:0 12px;margin-top:10px;}
.card{background:#1e293b;border-radius:15px;padding:20px;text-align:center;border:1px solid #334155;cursor:pointer;transition:.2s;}
.card span{font-size:36px;display:block;margin-bottom:8px;}
.list{padding:10px;}
.item{background:#020617;border-radius:14px;padding:12px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;border:1px solid #1e293b;}
.info{display:flex;gap:10px;align-items:center;}
.pic{width:50px;height:50px;border-radius:50%;object-fit:cover;border:2px solid #22c55e;}
.btn{background:#22c55e;color:black;padding:6px 12px;border-radius:10px;font-weight:bold;text-decoration:none;font-size:14px;}
.input-box{display:flex;padding:8px;background:#020617;position:sticky;bottom:0;}
.input-box input{flex:1;padding:12px;border-radius:10px;border:none;margin-right:8px;background:#1e293b;color:white;}
.input-box button{padding:12px 16px;border:none;border-radius:10px;background:#22c55e;font-weight:bold;cursor:pointer;}
.messages{flex:1;overflow-y:auto;padding:12px;}
.msg{margin-bottom:6px;padding:8px 12px;border-radius:12px;max-width:75%;}
.me{background:#22c55e;color:black;margin-left:auto;}
.other{background:#1e293b;}
.nav{display:flex;border-top:1px solid #1e293b;background:#020617;}
.nav div{flex:1;text-align:center;padding:12px;font-size:14px;opacity:.6;cursor:pointer;}
.nav .active{opacity:1;color:#22c55e;font-weight:bold;}
.filter{display:flex;justify-content:center;margin:10px 0;gap:10px;}
.filter button{padding:6px 12px;background:#334155;color:white;border:none;border-radius:10px;cursor:pointer;}
.filter .active{background:#22c55e;color:black;font-weight:bold;}
</style>
</head>

<body>

<div id="home" class="section show">
  <div class="header">Nearby Helper</div>
  <div class="filter">
    <button class="active" onclick="setFilter(100)">All</button>
    <button onclick="setFilter(1)">1 km</button>
    <button onclick="setFilter(5)">5 km</button>
    <button onclick="setFilter(10)">10 km</button>
  </div>
  <div class="list" id="helperList">Loading...</div>
</div>

<div id="chat" class="section">
  <div class="messages" id="messages"></div>
  <div class="input-box">
    <input type="text" id="msg" placeholder="Type message...">
    <button onclick="sendMsg()">Send</button>
  </div>
</div>

<div class="nav">
  <div class="active" onclick="showSection('home',this)">Helpers</div>
  <div onclick="showSection('chat',this)">Chat</div>
</div>

<script>
// Firebase
const firebaseConfig={
 apiKey:"AIzaSyCmOWTieB2TsG4caLergqTlfRYCB1_2WMM",
 authDomain:"ff-online-gaming-apps.firebaseapp.com",
 databaseURL:"https://ff-online-gaming-apps-default-rtdb.firebaseio.com",
 projectId:"ff-online-gaming-apps"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();
const auth=firebase.auth();
auth.signInAnonymously().catch(e=>alert(e.message));

// Live Chat
let chatId="global_chat_demo";
function sendMsg(){
 const text=msg.value.trim();
 if(!text) return;
 const sender=auth.currentUser.uid;
 db.ref("chats/"+chatId+"/messages").push({sender,text,time:Date.now()});
 msg.value="";
}
db.ref("chats/"+chatId+"/messages").on("child_added",snap=>{
 const m=snap.val();
 const div=document.createElement("div");
 div.className="msg "+(m.sender===auth.currentUser.uid?"me":"other");
 div.innerText=m.text;
 messages.appendChild(div);
 messages.scrollTop=messages.scrollHeight;
});

// User Location
let userLat=null,userLng=null;
navigator.geolocation.watchPosition(pos=>{
 userLat=pos.coords.latitude;
 userLng=pos.coords.longitude;
 loadHelpers();
},{enableHighAccuracy:true});

// Distance Function
function getKm(lat1,lon1,lat2,lon2){
 const R=6371;
 const dLat=(lat2-lat1)*Math.PI/180;
 const dLon=(lon2-lon1)*Math.PI/180;
 const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
 return (R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

// Nearby Filter
let maxDistance=100;
function setFilter(km){
 maxDistance=km;
 document.querySelectorAll('.filter button').forEach(b=>b.classList.remove('active'));
 event.target.classList.add('active');
 loadHelpers();
}

// Load Helpers
function loadHelpers(){
 const list=document.getElementById('helperList');
 if(!userLat) return;
 db.ref('helpers').once('value',snap=>{
   list.innerHTML="";
   let found=false;
   snap.forEach(c=>{
     const h=c.val();
     if(h.lat && h.lng){
       const dist=getKm(userLat,userLng,h.lat,h.lng);
       if(dist<=maxDistance){
         found=true;
         const div=document.createElement('div');
         div.className='item';
         div.innerHTML=`<div class="info">
          <img src="${h.photo}" class="pic">
          <div><b>${h.name}</b><br>${dist.toFixed(2)} km</div>
         </div>
         <a href="tel:${h.phone}" class="btn">Call</a>`;
         list.appendChild(div);
       }
     }
   });
   if(!found) list.innerHTML="<p style='text-align:center;opacity:0.5;'>No helpers nearby</p>";
 });
}

// Section Switch
function showSection(id,el){
 document.querySelectorAll('.section').forEach(s=>s.classList.remove('show'));
 document.getElementById(id).classList.add('show');
 document.querySelectorAll('.nav div').forEach(d=>d.classList.remove('active'));
 el.classList.add('active');
}
</script>
</body>
</html>
